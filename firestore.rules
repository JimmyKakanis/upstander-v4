rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin and get their schoolId
    function getAdminSchoolId() {
      let adminDoc = get(/databases/$(database)/documents/admins/$(request.auth.uid));
      return adminDoc.data.schoolId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    match /reports/{reportId} {
      // Allow anyone to create a report.
      // The `schoolId` must be present in the request data.
      allow create: if request.resource.data.schoolId is string;

      // Allow authenticated admins to read or update a report
      // if the report's schoolId matches their own schoolId.
      allow read: if request.auth != null && isAdmin() && getAdminSchoolId() == resource.data.schoolId;
      allow update: if request.auth != null
                    && isAdmin() && getAdminSchoolId() == resource.data.schoolId
                    && request.resource.data.typeOfBullying == resource.data.typeOfBullying
                    && request.resource.data.description == resource.data.description
                    && request.resource.data.date == resource.data.date
                    && request.resource.data.time == resource.data.time
                    && request.resource.data.location == resource.data.location
                    && request.resource.data.createdAt == resource.data.createdAt
                    && request.resource.data.schoolId == resource.data.schoolId
                    && request.resource.data.referenceCode == resource.data.referenceCode;
    }

    // Optional: Secure the admins collection
    match /admins/{adminId} {
      // Allow admins to read their own profile if the UID matches.
      allow read: if request.auth != null && request.auth.uid == adminId;
      
      // Do not allow anyone to create, update, or delete admin documents from the client.
      // This should be handled by a secure backend environment.
      allow create, update, delete: if false; 
    }
  }
}

